name: Build iOS App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true
        
    - name: Get Flutter dependencies
      run: flutter pub get
      
    - name: Run Flutter tests
      run: flutter test
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Install Apple Certificate
      if: github.event_name != 'pull_request'
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        
    - name: Install Provisioning Profile
      if: github.event_name != 'pull_request'
      uses: apple-actions/download-provisioning-profiles@v1
      with:
        bundle-id: com.autofirme.app
        issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
        api-key-id: ${{ secrets.APPSTORE_KEY_ID }}
        api-private-key: ${{ secrets.APPSTORE_PRIVATE_KEY }}
        
    - name: Update Xcode project with Team ID
      if: github.event_name != 'pull_request'
      run: |
        sed -i '' 's/DEVELOPMENT_TEAM = ;/DEVELOPMENT_TEAM = ${{ secrets.APPLE_TEAM_ID }};/g' ios/Runner.xcodeproj/project.pbxproj
        sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
        
    - name: Build iOS App (Debug)
      if: github.event_name == 'pull_request'
      run: |
        cd ios
        xcodebuild clean -workspace Runner.xcworkspace -scheme Runner
        flutter build ios --debug --no-codesign
        
    - name: Build iOS App (Release)
      if: github.event_name != 'pull_request'
      run: |
        flutter build ios --release
        
    - name: Archive iOS App
      if: github.event_name != 'pull_request'
      run: |
        cd ios
        xcodebuild -workspace Runner.xcworkspace \
                   -scheme Runner \
                   -configuration Release \
                   -destination generic/platform=iOS \
                   -archivePath build/Runner.xcarchive \
                   archive
                   
    - name: Export IPA
      if: github.event_name != 'pull_request'
      run: |
        cd ios
        xcodebuild -exportArchive \
                   -archivePath build/Runner.xcarchive \
                   -exportPath build/ \
                   -exportOptionsPlist exportOptions.plist
                   
    - name: Upload IPA Artifact
      if: github.event_name != 'pull_request'
      uses: actions/upload-artifact@v4
      with:
        name: ios-app
        path: ios/build/*.ipa
        retention-days: 30
        
    - name: Upload to TestFlight (Optional)
      if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
      run: |
        xcrun altool --upload-app --type ios \
                     --file ios/build/*.ipa \
                     --username ${{ secrets.APPLE_ID_EMAIL }} \
                     --password ${{ secrets.APPLE_ID_PASSWORD }}