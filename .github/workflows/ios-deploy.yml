name: iOS Build and App Store Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Load Environment Variables
      run: |
        if [ -f .env.github ]; then
          export $(cat .env.github | grep -v '^#' | xargs)
          echo "APPLE_ID=$APPLE_ID" >> $GITHUB_ENV
          echo "APPLE_TEAM_ID=$APPLE_TEAM_ID" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_ISSUER_ID=$APP_STORE_CONNECT_ISSUER_ID" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_KEY_ID=$APP_STORE_CONNECT_KEY_ID" >> $GITHUB_ENV
        fi

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'
        channel: 'stable'
        cache: true

    - name: Setup Keychain and API Key
      run: |
        echo "ðŸ”‘ Setting up keychain and API Key..."
        
        # Create keychain (needed for xcodebuild to store the fetched certificate)
        security create-keychain -p "temp_password" build.keychain
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "temp_password" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        
        # Create API Key directory
        mkdir -p ~/private_keys
        mkdir -p ~/.appstoreconnect/private_keys
        
        # Write API Key to file using Python for robust handling
        python3 -c "
        import os
        import base64
        import sys
        
        secret = os.environ['API_KEY_SECRET'].strip()
        path = os.path.expanduser('~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8')
        
        content_to_write = b''
        
        if secret.startswith('-----BEGIN'):
            print('â„¹ï¸ Detected raw PEM format')
            content_to_write = secret.encode('utf-8')
        else:
            print('â„¹ï¸ Input does not start with dashes, attempting Base64 decode')
            try:
                decoded = base64.b64decode(secret, validate=True)
                content_to_write = decoded
                print('âœ… Successfully decoded Base64')
            except Exception as e:
                print(f'âŒ Failed to decode Base64: {e}')
                print('âš ï¸ Falling back to treating input as raw content (unexpected format)')
                content_to_write = secret.encode('utf-8')

        # Sanity check
        if b'-----BEGIN PRIVATE KEY-----' not in content_to_write:
            print('âŒ WARNING: The resulting key file does not contain standard PEM headers.')
            print('This usually means the secret is incorrect or corrupted.')
        
        with open(path, 'wb') as f:
            f.write(content_to_write)
            # Ensure trailing newline
            if not content_to_write.endswith(b'\n'):
                f.write(b'\n')
        "
        
        # Copy to standard locations
        cp ~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8 ~/.appstoreconnect/private_keys/
        
        # Debug: Print first and last line to verify format (without leaking key)
        echo "Debug: Checking key file format..."
        head -n 1 ~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8
        tail -n 1 ~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8
        
        chmod 600 ~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8
        chmod 600 ~/.appstoreconnect/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8
        
        echo "âœ… API Key configured"
      env:
        API_KEY_SECRET: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}

    - name: Get Flutter Dependencies
      run: flutter pub get

    - name: Build iOS Release (No Codesign)
      run: |
        echo "ðŸ”¨ Building iOS release..."
        flutter build ios --release --no-tree-shake-icons --no-codesign
        echo "âœ… iOS build complete"

    - name: Build Archive with API Key
      run: |
        echo "ðŸ“¦ Creating Xcode archive..."
        cd ios
        
        # Use absolute path with $HOME to avoid tilde expansion issues
        AUTH_KEY_PATH="$HOME/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8"
        echo "Using Auth Key at: $AUTH_KEY_PATH"
        
        xcodebuild clean archive \
                   -workspace Runner.xcworkspace \
                   -scheme Runner \
                   -configuration Release \
                   -destination 'generic/platform=iOS' \
                   -archivePath $PWD/build/Runner.xcarchive \
                   -allowProvisioningUpdates \
                   -authenticationKeyPath "$AUTH_KEY_PATH" \
                   -authenticationKeyID "${{ env.APP_STORE_CONNECT_KEY_ID }}" \
                   -authenticationKeyIssuerID "${{ env.APP_STORE_CONNECT_ISSUER_ID }}" \
                   CODE_SIGN_STYLE=Automatic \
                   DEVELOPMENT_TEAM="${{ env.APPLE_TEAM_ID }}" \
                   PRODUCT_BUNDLE_IDENTIFIER="com.autofirme.app"
        echo "âœ… Archive created successfully"

    - name: Export IPA for App Store
      run: |
        echo "ðŸ“± Exporting IPA for App Store..."
        cd ios
        
        AUTH_KEY_PATH="$HOME/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8"
        
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>teamID</key>
          <string>${{ env.APPLE_TEAM_ID }}</string>
          <key>method</key>
          <string>app-store</string>
          <key>uploadBitcode</key>
          <false/>
          <key>compileBitcode</key>
          <false/>
          <key>uploadSymbols</key>
          <true/>
          <key>signingStyle</key>
          <string>automatic</string>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
                   -archivePath $PWD/build/Runner.xcarchive \
                   -exportOptionsPlist $PWD/ExportOptions.plist \
                   -exportPath $PWD/build \
                   -allowProvisioningUpdates \
                   -authenticationKeyPath "$AUTH_KEY_PATH" \
                   -authenticationKeyID "${{ env.APP_STORE_CONNECT_KEY_ID }}" \
                   -authenticationKeyIssuerID "${{ env.APP_STORE_CONNECT_ISSUER_ID }}"
        echo "âœ… IPA exported successfully"

    - name: Upload to App Store Connect
      run: |
        echo "ðŸš€ Uploading to App Store Connect..."
        cd ios/build
        
        # Find the IPA file
        IPA_PATH=$(find . -name "*.ipa" | head -n 1)
        echo "Found IPA: $IPA_PATH"
        
        # Upload using altool with API Key
        xcrun altool --upload-app \
                     --type ios \
                     --file "$IPA_PATH" \
                     --apiKey "${{ env.APP_STORE_CONNECT_KEY_ID }}" \
                     --apiIssuer "${{ env.APP_STORE_CONNECT_ISSUER_ID }}" \
                     --verbose
        
        echo "âœ… Upload to App Store Connect completed!"

    - name: Clean up
      run: |
        echo "ðŸ§¹ Cleaning up..."
        security delete-keychain build.keychain || true
        rm -rf ~/private_keys
        rm -rf ~/.appstoreconnect/private_keys
