name: iOS Build and App Store Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Load Environment Variables
      run: |
        if [ -f .env.github ]; then
          export $(cat .env.github | grep -v '^#' | xargs)
          echo "APPLE_ID=$APPLE_ID" >> $GITHUB_ENV
          echo "APPLE_TEAM_ID=$APPLE_TEAM_ID" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_ISSUER_ID=$APP_STORE_CONNECT_ISSUER_ID" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_KEY_ID=$APP_STORE_CONNECT_KEY_ID" >> $GITHUB_ENV
        fi

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'
        channel: 'stable'
        cache: true

    - name: Setup Keychain and API Key
      run: |
        echo "üîë Setting up keychain and API Key..."
        
        # Create keychain (needed for xcodebuild to store the fetched certificate)
        security create-keychain -p "temp_password" build.keychain
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "temp_password" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        
        # Create API Key directory
        mkdir -p ~/private_keys
        mkdir -p ~/.appstoreconnect/private_keys
        
        # Write API Key to file using Python for robust handling
        python3 -c "
        import os
        import base64
        import sys
        
        secret = os.environ.get('API_KEY_SECRET', '').strip()
        
        print(f'‚ÑπÔ∏è Debug: Secret length received: {len(secret)}')
        
        if not secret:
            print('‚ùå CRITICAL ERROR: The secret APP_STORE_CONNECT_PRIVATE_KEY is empty!')
            print('Please ensure you have added the secret in GitHub Settings > Secrets and variables > Actions.')
            sys.exit(1)

        path = os.path.expanduser('~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8')
        
        content = b''
        if '-----BEGIN PRIVATE KEY-----' in secret:
            print('‚ÑπÔ∏è Detected PEM format')
            # Normalize line endings to \n to satisfy strict parsers
            clean_secret = secret.replace('\r\n', '\n').replace('\r', '\n')
            content = clean_secret.encode('utf-8')
        else:
            print('‚ÑπÔ∏è Detected Base64 format (or unknown format)')
            # Remove any whitespace/newlines from base64 string
            clean_secret = ''.join(secret.split())
            try:
                content = base64.b64decode(clean_secret)
                print(f'‚úÖ Successfully decoded Base64 (Length: {len(content)} bytes)')
            except Exception as e:
                print(f'‚ùå Failed to decode Base64: {e}')
                sys.exit(1)

        # Force LF line endings just in case
        if b'\r\n' in content:
            print('‚ÑπÔ∏è Converting CRLF to LF in binary content')
            content = content.replace(b'\r\n', b'\n')
            
        with open(path, 'wb') as f:
            f.write(content)
            # Ensure single trailing newline
            if not content.endswith(b'\n'):
                f.write(b'\n')
        "
        
        # Copy to standard locations
        cp ~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8 ~/.appstoreconnect/private_keys/
        
        # Debug: Inspect the file (safe info only)
        echo "üîç Inspecting generated key file..."
        ls -l ~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8
        echo "First line:"
        head -n 1 ~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8
        echo "Hex dump of first 20 bytes:"
        head -c 20 ~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8 | xxd
        
        # Validate the key using altool (this checks if the key is valid before xcodebuild runs)
        echo "üîç Validating API Key with altool..."
        xcrun altool --list-providers \
                     --apiKey "${{ env.APP_STORE_CONNECT_KEY_ID }}" \
                     --apiIssuer "${{ env.APP_STORE_CONNECT_ISSUER_ID }}"
        
        echo "‚úÖ API Key configured and validated"
      env:
        API_KEY_SECRET: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}

    - name: Get Flutter Dependencies
      run: flutter pub get

    - name: Setup Fastlane
      run: |
        cd ios
        # Ensure fastlane is up to date
        gem install fastlane
        
    - name: Deploy with Fastlane
      run: |
        cd ios
        fastlane deploy
      env:
        APP_STORE_CONNECT_KEY_ID: ${{ env.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ env.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        APPLE_TEAM_ID: ${{ env.APPLE_TEAM_ID }}
        MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.GITHUB_TOKEN }} # Just in case

    - name: Clean up
      if: always()
      run: |
        echo "üßπ Cleaning up..."
        security delete-keychain build.keychain || true
        rm -rf ~/private_keys
        rm -rf ~/.appstoreconnect/private_keys
