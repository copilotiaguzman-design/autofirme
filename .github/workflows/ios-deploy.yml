name: iOS Build and App Store Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: macos-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Load Environment Variables
      run: |
        if [ -f .env.github ]; then
          export $(cat .env.github | grep -v '^#' | xargs)
          echo "APPLE_ID=$APPLE_ID" >> $GITHUB_ENV
          echo "APPLE_TEAM_ID=$APPLE_TEAM_ID" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_ISSUER_ID=$APP_STORE_CONNECT_ISSUER_ID" >> $GITHUB_ENV
          echo "APP_STORE_CONNECT_KEY_ID=$APP_STORE_CONNECT_KEY_ID" >> $GITHUB_ENV
        fi

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'
        channel: 'stable'
        cache: true

    - name: Setup Keychain and Certificates
      run: |
        echo "ðŸ”‘ Setting up Keychain and Certificates..."
        
        # Create a temporary keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        KEYCHAIN_PASSWORD="temporary_password"
        
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        
        # Import Distribution Certificate
        echo "ðŸ“œ Importing Distribution Certificate..."
        CERT_PATH=$RUNNER_TEMP/distribution.p12
        echo "$DISTRIBUTION_CERTIFICATE_BASE64" | base64 --decode > "$CERT_PATH"
        
        security import "$CERT_PATH" \
          -P "$DISTRIBUTION_CERTIFICATE_PASSWORD" \
          -A \
          -t cert \
          -f pkcs12 \
          -k "$KEYCHAIN_PATH"
        
        # Add keychain to search list and make it default
        security list-keychains -d user -s "$KEYCHAIN_PATH" $(security list-keychains -d user | tr -d '"')
        security default-keychain -s "$KEYCHAIN_PATH"
        
        # Set key partition list (required for codesign to access the key)
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        
        # Verify certificate was imported
        echo "ðŸ” Verifying certificate import..."
        security find-identity -v -p codesigning "$KEYCHAIN_PATH"
        
        # Create API Key directory and file
        mkdir -p ~/private_keys
        mkdir -p ~/.appstoreconnect/private_keys
        
        # Write API Key to file
        python3 -c "
import os
import base64
import sys

secret = os.environ.get('API_KEY_SECRET', '').strip()

if not secret:
    print('âŒ CRITICAL ERROR: The secret APP_STORE_CONNECT_PRIVATE_KEY is empty!')
    sys.exit(1)

path = os.path.expanduser('~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8')

if '-----BEGIN PRIVATE KEY-----' in secret:
    content = secret.replace('\r\n', '\n').replace('\r', '\n').encode('utf-8')
else:
    clean_secret = ''.join(secret.split())
    content = base64.b64decode(clean_secret)

with open(path, 'wb') as f:
    f.write(content)
    if not content.endswith(b'\n'):
        f.write(b'\n')
print('âœ… API Key written successfully')
"
        
        cp ~/private_keys/AuthKey_${{ env.APP_STORE_CONNECT_KEY_ID }}.p8 ~/.appstoreconnect/private_keys/
        
        # Export keychain path for Fastlane
        echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> $GITHUB_ENV
        echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV
        
        echo "âœ… Keychain and certificates configured"
      env:
        API_KEY_SECRET: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        DISTRIBUTION_CERTIFICATE_BASE64: ${{ secrets.DISTRIBUTION_CERTIFICATE_BASE64 }}
        DISTRIBUTION_CERTIFICATE_PASSWORD: ${{ secrets.DISTRIBUTION_CERTIFICATE_PASSWORD }}

    - name: Get Flutter Dependencies
      run: flutter pub get

    - name: Setup Fastlane
      run: |
        cd ios
        # Ensure fastlane is up to date
        gem install fastlane
        
    - name: Deploy with Fastlane
      run: |
        cd ios
        fastlane deploy
      env:
        APP_STORE_CONNECT_KEY_ID: ${{ env.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ env.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        APPLE_TEAM_ID: ${{ env.APPLE_TEAM_ID }}
        KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
        KEYCHAIN_PASSWORD: ${{ env.KEYCHAIN_PASSWORD }}

    - name: Clean up
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        security delete-keychain "$KEYCHAIN_PATH" || true
        rm -rf ~/private_keys
        rm -rf ~/.appstoreconnect/private_keys
      env:
        KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
