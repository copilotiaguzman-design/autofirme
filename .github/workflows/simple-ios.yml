name: iOS App Store Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.38.3'
        channel: 'stable'
        cache: true
        
    - name: Get dependencies
      run: flutter pub get
      
    - name: Run tests
      run: flutter test || echo "Tests completed"
      
    - name: Setup Distribution Certificate
      run: |
        echo "ðŸ”‘ Setting up Apple Distribution certificate..."
        
        # Use the distribution certificate
        cp ios_distribution_final.p12 ios_certificate.p12
        
        # Import certificate (no password)
        security create-keychain -p "" build.keychain
        security import ios_certificate.p12 -k build.keychain -P "" -T /usr/bin/codesign
        security list-keychains -s build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings build.keychain
        echo "âœ… Distribution certificate configured"
        
    - name: Build iOS Release
      run: |
        echo "ðŸ—ï¸ Building iOS release for App Store..."
        flutter build ios --release --no-codesign
        echo "âœ… Flutter build completed!"
        
    - name: Build and Archive
      run: |
        echo "ðŸ“¦ Creating App Store archive..."
        cd ios
        
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath Runner.xcarchive \
          archive
          
        echo "âœ… Archive created successfully!"
        
    - name: Export IPA
      run: |
        echo "ðŸ“± Exporting IPA for App Store..."
        cd ios
        
        # Load configuration
        source ../.env.github
        
        # Create export options
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>app-store</string>
          <key>teamID</key>
          <string>$APPLE_TEAM_ID</string>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath Runner.xcarchive \
          -exportPath . \
          -exportOptionsPlist ExportOptions.plist
          
        echo "âœ… IPA exported successfully!"
        
    - name: Upload to App Store
      env:
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
      run: |
        echo "ðŸš€ Uploading to App Store Connect..."
        cd ios
        
        # Load configuration
        source .env.github
        
        xcrun altool --upload-app \
          --type ios \
          --file Runner.ipa \
          --username "$APPLE_ID" \
          --password "$APP_SPECIFIC_PASSWORD"
          
        echo "âœ… App uploaded to App Store Connect!"
        echo "ðŸŽ‰ Check App Store Connect for processing status"